
<!DOCTYPE html>

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>Some Intuition on Lenses - Bits, Bytes, and Words</title>
<meta name="author" content="Jake Zimmerman">




<meta name="description" content="I've been working with lenses on a small project recently, and I thought I'd write up some of my intuition about how they work.
">

<meta name="keywords" content="haskell types ">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.jez.io/lens-intuition">
<meta property="og:title" content="Some Intuition on Lenses">
<meta property="og:description" content="I've been working with lenses on a small project recently, and I thought I'd write up some of my intuition about how they work.
">
<meta property="og:image" content="">
<meta property="og:site_name" content="Bits, Bytes, and Words">

<link rel="canonical" href="https://blog.jez.io/lens-intuition">
<link href="/touch-icon.png" rel="apple-touch-icon-precomposed">
<link href="/favicon@2x.png" rel="icon" sizes="32x32">
<link href="/favicon.png" rel="icon" sizes="16x16">
<link href="/fonts/concourse.css" rel="stylesheet">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Bits, Bytes, and Words" type="application/atom+xml">




</head>

<body id="post" class="">

<nav class="Navigation">
  <ul class="Tags">
    
      <li class="Tag">
        
          <a href="/">Home</a>
        
      </li>
    
      <li class="Tag">
        
          <a href="/categories/">Categories</a>
        
      </li>
    
      <li class="Tag">
        
          <a href="https://jez.io">About</a>
        
      </li>
    
  </ul>
</nav>





<div class="EntryHeader">
  <h1 class="EntryHeader-title">Some Intuition on Lenses</h1>
  <h2 class="EntryHeader-subtitle">February 6, 2018</h2>

  <ul class="Tags">
    
  </ul>
</div>



<div id="main" role="main">
  <article class="Post-content">
    <p>I&rsquo;ve been working on a small project in Haskell recently that uses the
<a href="https://hackage.haskell.org/package/wreq">wreq</a> library. It&rsquo;s an HTTP client library that exposes most of its
functionality through lenses. Using this library is my first time really
using lenses pervasively, so I&rsquo;ve spent some time trying to understand
how lenses really work.</p>

<!-- more -->


<p>Lenses try to bring the concept of getters and setters into a functional
setting. Here, &ldquo;functional&rdquo; means that lenses prioritize composition
(chaining one lens after another) and immutability (returning a new
data structure<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> instead of mutating the old one in place).</p>

<p>In a functional setting, if we have a type <code>s</code> and we want to get some
field of type <code>a</code> from it, a getter is just a function <code>s -&gt; a</code>.</p>

<p>Similarly, a setter that updates that field has the type <code>s -&gt; a -&gt; s</code>
which takes the old <code>s</code> and slots the <code>a</code> into it, giving us back a new
<code>s</code>.</p>

<p>Let&rsquo;s see if we can build up some intuition, starting with these types
and ending with the type of <code>Lens'</code> from the lens library:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">type</span> <span class="kt">Lens'</span> <span class="n">s</span> <span class="n">a</span> <span class="o">=</span> <span class="n">forall</span> <span class="n">f</span><span class="o">.</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">s</span><span class="p">)</span></span></code></pre></td></tr></table></div></figure>


<p>In particular, let&rsquo;s start with our getter:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="n">fn</span> <span class="o">::</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">a</span></span></code></pre></td></tr></table></div></figure>


<p>The first thing we can do is convert it to continuation-passing style
(CPS). In CPS form, a function throws it&rsquo;s return value to a
user-specified callback function (or continuation) instead of returning
its value directly. So our <code>s -&gt; a</code> becomes:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="n">fn</span> <span class="o">::</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">r</span></span></code></pre></td></tr></table></div></figure>


<p>After we&rsquo;re done computing an <code>a</code> from the <code>s</code> we were given, we throw
it to the continuation of type <code>a -&gt; r</code>. We then take <strong>that</strong> result and
return it. I like to put parens around the second function:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="n">fn</span> <span class="o">::</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">)</span></span></code></pre></td></tr></table></div></figure>


<p>But it&rsquo;s kind of hard to do anything with this, because <code>r</code> is
completely arbitrary. It&rsquo;s chosen by whoever calls us, so we have no
information about what can be done on an <code>r</code>. What if we instead require
that the continuation result be a Functor?</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="n">fn</span> <span class="o">::</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">r</span><span class="p">)</span></span></code></pre></td></tr></table></div></figure>


<p>And while we&rsquo;re at it, it was kind an arbitrary stipulation that the <code>f
r</code> of the continuation&rsquo;s callback be the same as the <code>f r</code> of our
function&rsquo;s result type, so let&rsquo;s relax that:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="n">fn</span> <span class="o">::</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">t</span><span class="p">)</span></span></code></pre></td></tr></table></div></figure>


<p>This relaxation makes sense as long as we know of some function with
type <code>b -&gt; t</code>, because then we could</p>

<ul>
<li>take the <code>s</code>,</li>
<li>apply our <code>s -&gt; a</code> getter to get an <code>a</code>,</li>
<li>throw this to the <code>a -&gt; f b</code> continuation to get an <code>f b</code>, and</li>
<li><code>fmap</code> our <code>b -&gt; t</code> function over this to get an <code>f t</code>.</li>
</ul>


<p>In general, we might not know of some <code>b -&gt; t</code> function. But remember
that we do have our <code>s -&gt; a -&gt; s</code> function! So if we choose <code>b = a</code> and
<code>s = t</code>, then we get:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="n">fn</span> <span class="o">::</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">s</span><span class="p">)</span></span></code></pre></td></tr></table></div></figure>


<p>With a function like this, we can</p>

<ul>
<li>take the <code>s</code>,</li>
<li>apply our <code>s -&gt; a</code> getter to get an <code>a</code>,</li>
<li>throw our <code>a</code> to the <code>a -&gt; f a</code> continuation to get an <code>f a</code>,</li>
<li>partially apply our <code>s -&gt; a -&gt; s</code> setter with the <code>s</code> we were given,

<ul>
<li>(so we have an <code>a -&gt; s</code> now)</li>
</ul>
</li>
<li><code>fmap</code> this <code>a -&gt; s</code> function over the <code>f a</code> to get an <code>f s</code></li>
</ul>


<p>And we&rsquo;ve arrived at the type of <code>Lens'</code>! What really happened here was
we marked the interesting<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> part of our data structure with
a Functor. So if we choose an interesting Functor instance, it&rsquo;ll act on
that point.</p>

<p>What if the Functor we choose is <code>Const a</code>? Well, then it&rsquo;s on us to
provide an <code>a -&gt; f a</code> continuation. Since we&rsquo;ve chosen <code>f = Const a</code> we
have to come up with a function with type <code>a -&gt; Const a a</code>. This is a
special case of the <code>Const</code> constructor:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kt">Const</span> <span class="o">::</span> <span class="n">forall</span> <span class="n">b</span><span class="o">.</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Const</span> <span class="n">a</span> <span class="n">b</span></span></code></pre></td></tr></table></div></figure>


<p>So our continuation remembers the <code>a</code> it was given. After the last step,
we&rsquo;ll have a <code>Const a s</code>, which we can call <code>getConst</code> on to give us
the <code>a</code> we stashed. So by choosing <code>Const</code>, our lens acts like a getter!</p>

<p>What if the Functor we choose is <code>Identity</code>? Now we have to provide a
function <code>a -&gt; Identity a</code>. At this point, you probably guessed this
makes our lens a setter. If we&rsquo;re trying to use a setter, then we&rsquo;ll
also have access to some new <code>y :: a</code> that we want to use to slot into
our <code>s</code>. Let&rsquo;s see what happens if we make this our continuation:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="n">inj</span> <span class="o">::</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Identity</span> <span class="n">a</span>
</span><span class='line'><span class="n">inj</span> <span class="n">x</span> <span class="o">=</span> <span class="kt">Identity</span> <span class="n">y</span></span></code></pre></td></tr></table></div></figure>


<p>The <code>x :: a</code> is the old value of <code>x</code>. By dropping <code>x</code> on the floor and
returning <code>y</code> instead, we&rsquo;ve slotted <code>y</code> into our <code>s</code>. Remember
that above we took the <code>f a</code> and our setter <code>s -&gt; a -&gt; s</code>, partially
applied it to get <code>a -&gt; s</code>, and <code>fmap</code>&rsquo;d this over the <code>f a</code>. Since our
continuation now holds a wrapped up <code>y :: a</code>, we&rsquo;ll reconstruct a new
<code>s</code> using <code>y</code>. Great!</p>

<h2>More Resources</h2>

<p>These are some resources that helped make lenses less intimidating for
me:</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=cefnmjtAolY">Lenses, Folds, and
Traversals</a> (video)

<ul>
<li>by Edward Kmett, the author of the lens library</li>
<li>highly technical, long, exhaustive</li>
</ul>
</li>
<li><a href="https://hackage.haskell.org/package/lens-4.16/docs/Control-Lens-Getter.html">Control.Lens.Getter</a> (hackage)

<ul>
<li>in particular, the first few lines of the intro paragraph</li>
<li>also: <code>(^.)</code> to see where the <code>f</code> becomes <code>Const a</code></li>
</ul>
</li>
<li><code>#haskell</code> on Freenode

<ul>
<li>Special thanks to <code>johnw_</code> and <code>dminuoso</code>!</li>
</ul>
</li>
</ul>


<p>Lenses seem intimidating at first, but in the end they&rsquo;re just a really
cool uses of functions. We use nothing more exotic here than the Functor
type class and a couple of Functor instances, and in return we get such
concise code!</p>

<!-- vim:tw=72
-->

<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>It&rsquo;s common to think that &ldquo;immutable&rdquo; means &ldquo;copy the entire thing&rdquo; and then change the parts you care about. But if you start with <strong>all data</strong> being immutable, then you only need to allocate new memory for the subcomponents of your data structure that <strong>actually</strong> changed. Everything else can be shared by the old and the new.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>In the same way that glass lenses focus light on a point, functional lenses focus a data structure on a point! Isn&rsquo;t it neat how that name works out? It&rsquo;s certainly a cooler name than &ldquo;generalized getter/setter <a href="https://www.youtube.com/watch?v=pD_imYhNoQ4">wombo combo</a>&rdquo; (video, language warning).<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>


    <footer class="entry-meta">
      <span class="entry-tags">
        <ul class="Tags">
          
            <li class="Tag">
              <a href="/categories/#haskell" title="Pages tagged haskell">haskell</a>
            </li>
          
            <li class="Tag">
              <a href="/categories/#types" title="Pages tagged types">types</a>
            </li>
          
        </ul>
      </span>
      <span class="entry-date date published updated"><time datetime="2018-02-06T00:09:43-05:00">February 6, 2018</time></span>
      
    </footer>
  </div>
  
  <div class="read-more">
    
      <div class="read-more-header">
        <a href="/on-language-choice/" class="Button">Read More</a>
      </div><!-- /.read-more-header -->
      <div class="read-more-content">
        <h3><a href="/on-language-choice/" title="On Programming Language Choice">On Programming Language Choice</a></h3>
      <p>Absolutely the most regret from choosing a programming language has come from forgetting to ask this question: <a href="/on-language-choice/"> Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="/continuations-notes/" title="Notes on Continuations">Notes on Continuations</a></h4>
            <span>Published on June 18, 2019</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="/bash-debugger/" title="A Debugger for Bash in Six Lines of Bash">A Debugger for Bash in Six Lines of Bash</a></h4>
            <span>Published on June 16, 2019</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
  </div><!-- /.read-more -->


</div>

<div class="footer-wrapper">
  Blog source on <a href="https://github.com/jez/blog">GitHub</a>.

</div>

</body>
</html>
