
<!DOCTYPE html>

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>Sorbet Does Not Have Checked Exceptions - Bits, Bytes, and Words</title>
<meta name="author" content="Jake Zimmerman">




<meta name="description" content="Sorbet does not support checked exceptions, and I don't think it ever should.">

<meta name="keywords" content="ruby sorbet types ">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->

  <meta name="twitter:card" content="summary">
  <meta name="twitter:image" content="https://blog.jez.io/touch-icon.png">
  <meta name="twitter:title" content="Sorbet Does Not Have Checked Exceptions">
  <meta name="twitter:description" content="Sorbet does not support checked exceptions, and I don't think it ever should.">
  <meta name="twitter:creator" content="@jez_io">


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.jez.io/union-types-checked-exceptions">
<meta property="og:title" content="Sorbet Does Not Have Checked Exceptions">
<meta property="og:description" content="Sorbet does not support checked exceptions, and I don't think it ever should.">
<meta property="og:image" content="https://blog.jez.io/touch-icon.png">
<meta property="og:site_name" content="Bits, Bytes, and Words">

<link rel="canonical" href="https://blog.jez.io/union-types-checked-exceptions">
<link href="/touch-icon.png" rel="apple-touch-icon-precomposed">
<link href="/favicon@2x.png" rel="icon" sizes="32x32">
<link href="/favicon.png" rel="icon" sizes="16x16">
<link href="/fonts/concourse.css" rel="stylesheet">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Bits, Bytes, and Words" type="application/atom+xml">




</head>

<body id="post" class="">

<nav class="Navigation">
  <ul class="Tags">
    
      <li class="Tag">
        
          <a href="/">Home</a>
        
      </li>
    
      <li class="Tag">
        
          <a href="/categories/">Categories</a>
        
      </li>
    
      <li class="Tag">
        
          <a href="https://jez.io">About</a>
        
      </li>
    
  </ul>
</nav>





<div class="EntryHeader">
  <h1 class="EntryHeader-title">Sorbet Does Not Have Checked Exceptions</h1>
  <h2 class="EntryHeader-subtitle">May 29, 2021</h2>

  <ul class="Tags">
    
  </ul>
</div>



<div id="main" role="main">
  <article class="Post-content">
    <p>People new to Sorbet ask this all the time:</p>

<blockquote><p>Does Sorbet support checked exceptions, like Java?</p></blockquote>

<p>(In fact, this was the <a href="https://youtu.be/odmlf_ezsBo?t=1921">first ever question</a> I was asked at my <a href="https://jez.io/talks/state-of-sorbet-2019/">first
ever conference talk</a>.)</p>

<p>The answer: Sorbet doesn&rsquo;t support checked exceptions, and I don&rsquo;t think
it ever should.</p>

<!-- more -->


<p>Before I dive in: chances are you&rsquo;re reading this because you asked the
question above and someone linked you this. Or maybe you saw the title
and just happened to click. Either way, I&rsquo;m going to take for granted
that you know what I mean by &ldquo;checked exceptions.&rdquo; If you want a quick
refresher, jump down to the <a href="#appendix">Appendix</a> and then come back.</p>

<p>My claim is that checked exceptions are a poor man&rsquo;s ad hoc union types,
that Sorbet has ad hoc union types, and thus that Sorbet doesn&rsquo;t need
checked exceptions.</p>

<p>I&rsquo;ll discuss this claim in three parts:</p>

<ul>
<li>I&rsquo;ll give some background on a key feature of Sorbet&rsquo;s union types,
which are unique compared with union types in many other languages.</li>
<li>I&rsquo;ll describe a translation from checked exceptions in Java to
union-typed returns in Ruby with a concrete example.</li>
<li>I&rsquo;ll give evidence for why the union types approach is better.</li>
</ul>


<p>(I won&rsquo;t hold it against you if you skip to the conclusion and come back
for the lead up. It&rsquo;s what I know I&rsquo;d do too.)</p>

<h2>Background: Sorbet&rsquo;s union types</h2>

<blockquote><p>The throws clause is the only point in the entire Java language that
allows union types. You can tack &ldquo;throws A,B,C&rdquo; onto a method
signature meaning it might throw A or B or C, but outside of the
throws clause you cannot say &ldquo;type A or B or C&rdquo; in Java.</p>

<p>â€” James Iry, <em><a href="http://james-iry.blogspot.com/2012/02/checked-exceptions-might-have-their.html">Checked Exceptions Might Have Their Place, But It Isn&rsquo;t
In Java</a></em> (2012)</p></blockquote>

<p>Sorbet supports <a href="https://sorbet.org/docs/union-types">union types</a>. More specifically, Sorbet&rsquo;s union types
are ad hoc: any number of types can be unioned together on demand:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sig</span> <span class="p">{</span><span class="n">returns</span><span class="p">(</span><span class="no">T</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="no">A</span><span class="p">,</span> <span class="no">B</span><span class="p">,</span> <span class="no">C</span><span class="p">))}</span>
</span><span class='line'><span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">;</span> <span class="k">end</span></span></code></pre></td></tr></table></div></figure>


<p>By contrast, many languages with union types require predeclaring a
union&rsquo;s variants, for example in Rust:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">enum</span> <span class="n">AorBorC</span> <span class="p">{</span>
</span><span class='line'>    <span class="nf">A</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
</span><span class='line'>    <span class="nf">B</span><span class="p">(</span><span class="n">B</span><span class="p">),</span>
</span><span class='line'>    <span class="nf">C</span><span class="p">(</span><span class="n">C</span><span class="p">),</span>
</span><span class='line'><span class="p">}</span></span></code></pre></td></tr></table></div></figure>


<p>(Rust is not alone here. There are benefits to having an explicit name.
Requiring a name makes it <a href="https://www.parsonsmatt.org/2018/11/03/trouble_with_typed_errors.html">harder to use union types to use for
errors</a>. This article is not about Rust, please
don&rsquo;t @ me.)</p>

<p>This &ldquo;on demand&rdquo; characteristic of union types is similar to Java&rsquo;s
<code>throws</code> clause, but more powerful: <code>throws A, B, C</code> is not a type,
while <code>T.any(A, B, C)</code> is. We&rsquo;ll see why that matters below.</p>

<h2>Example: From checked exceptions to union types</h2>

<p>Using Sorbet&rsquo;s ad hoc union types, it&rsquo;s mechanical to convert Java-style
checked exceptions to Sorbet-annotated Ruby. To demonstrate:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Currency</span> <span class="nf">parseCurrency</span><span class="o">(</span><span class="n">String</span> <span class="n">currencyStr</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ParseException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Currency</span> <span class="n">currency</span> <span class="o">=</span> <span class="n">KNOWN_CURRENCIES</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currencyStr</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">currency</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ParseException</span><span class="o">(</span>
</span><span class='line'>          <span class="s">"'"</span> <span class="n">currencyStr</span> <span class="o">+</span> <span class="s">"' is not a valid currency"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">currency</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span></span></code></pre></td></tr></table></div></figure>


<p>This is a somewhat contrived Java method, but it&rsquo;ll be good enough to
demonstrate the concepts.</p>

<p>If <code>parseCurrency</code> is given a string it can&rsquo;t handle, it raises a
<code>ParseException</code>. It declares this with <code>throws</code> because
<code>ParseException</code> is a checked exception. If the currency string is
recognized, it returns some <code>Currency</code> object.</p>

<p>Here&rsquo;s how we&rsquo;d write that in Sorbet:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># (0) Ruby's standard library doesn't have `ParseException`,</span>
</span><span class='line'><span class="c1"># so I've re-implemented it.</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ParseError</span> <span class="o">&lt;</span> <span class="no">T</span><span class="o">::</span><span class="no">Struct</span>
</span><span class='line'>  <span class="n">const</span> <span class="ss">:message</span><span class="p">,</span> <span class="no">String</span>
</span><span class='line'>  <span class="n">const</span> <span class="ss">:offset</span><span class="p">,</span> <span class="no">Integer</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># (1) return type + `throws` becomes just `returns`</span>
</span><span class='line'><span class="c1"># (2) Return type uses `T.any`</span>
</span><span class='line'><span class="n">sig</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">params</span><span class="p">(</span><span class="ss">currency_str: </span><span class="no">String</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nf">returns</span><span class="p">(</span><span class="no">T</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="no">Currency</span><span class="p">,</span> <span class="no">ParseError</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">def</span> <span class="nf">parse_currency</span><span class="p">(</span><span class="n">currency_str</span><span class="p">)</span>
</span><span class='line'>  <span class="n">currency</span> <span class="o">=</span> <span class="no">KNOWN_CURRENCIES</span><span class="p">[</span><span class="n">currency_str</span><span class="p">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">currency</span><span class="p">.</span><span class="nf">nil?</span>
</span><span class='line'>    <span class="c1"># (3) `throw` becomes `return`</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">ParseError</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
</span><span class='line'>      <span class="ss">message: </span><span class="s2">"'</span><span class="si">#{</span><span class="n">currency_str</span><span class="si">}</span><span class="s2">' is not a valid currency"</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">offset: </span><span class="mi">0</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">currency</span>
</span><span class='line'><span class="k">end</span></span></code></pre></td></tr></table></div></figure>


<p>The important changes:</p>

<ol>
<li>Where Java had a return type and a <code>throws</code> clause, Sorbet just has a
return type.</li>
<li>Sorbet&rsquo;s return type is a union type (<code>T.any(...)</code>). It mentions the Java
method&rsquo;s return type and all the exceptions mentioned in the <code>throws</code>.</li>
<li>Where the Java example uses <code>throw</code>, the Ruby example uses <code>return</code>.</li>
</ol>


<p>The translation isn&rsquo;t complete until we see how the <code>parseCurrency</code>
caller side changes:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Charge</span> <span class="nf">createCharge</span><span class="o">(</span><span class="kt">int</span> <span class="n">amount</span><span class="o">,</span> <span class="n">String</span> <span class="n">currencyStr</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ParseException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Currency</span> <span class="n">currency</span> <span class="o">=</span> <span class="n">parseCurrency</span><span class="o">(</span><span class="n">currencyStr</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">Charge</span><span class="o">(</span><span class="n">amount</span><span class="o">,</span> <span class="n">currency</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span></span></code></pre></td></tr></table></div></figure>


<p>With Sorbet, this Java snippet becomes:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sig</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">params</span><span class="p">(</span><span class="ss">amount: </span><span class="no">Integer</span><span class="p">,</span> <span class="ss">currency_str: </span><span class="no">String</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nf">returns</span><span class="p">(</span><span class="no">T</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="no">Charge</span><span class="p">,</span> <span class="no">ParseError</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">def</span> <span class="nf">create_charge</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency_str</span><span class="p">)</span>
</span><span class='line'>  <span class="n">currency</span> <span class="o">=</span> <span class="n">parse_currency</span><span class="p">(</span><span class="n">currency_str</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">currency</span> <span class="k">unless</span> <span class="n">currency</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Currency</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Charge</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">amount: </span><span class="n">amount</span><span class="p">,</span> <span class="ss">currency: </span><span class="n">currency</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span></span></code></pre></td></tr></table></div></figure>


<p>As before, the <code>throws</code> clause in Java becomes a union-typed return in Ruby.</p>

<p>The new bit is the explicit <code>return ... unless ...</code>. Whereas uncaught
exceptions implicitly bubble up to the caller, return values only bubble
up if explicitly returned. This is a key benefit of the union types
approach, which brings us to our next section.</p>

<h2>Analysis: Why the union types approach is better</h2>

<p>To recap, Sorbet&rsquo;s union types are ad hoc, much in the same sense as the
classes mentioned in Java&rsquo;s <code>throws</code> clause. When converting from <code>Java</code> to
<code>Ruby</code>, a single, union-typed return takes the place of a separate return
type and <code>throws</code> clause.</p>

<p>First off, this translation preserves the best parts of checked
exceptions:</p>

<ul>
<li><p>A method&rsquo;s failure modes still appear in an <strong>explicit, public API</strong>.</p>

<p>In both Java and Ruby, the method signature behaves as machine-checked
error documentation.</p></li>
<li><p>Ad hoc error specifications enable <strong>low-friction composition</strong>.</p>

<p>In both Java and Ruby, if our method is the first to combine two
methods with unrelated failure modes, there&rsquo;s no ceremony to
predeclare that combination.  Instead, we just mention one more class
in the method&rsquo;s signature.</p></li>
</ul>


<p>What&rsquo;s more, the union types approach has a couple unique benefits:</p>

<ul>
<li><p>As a language feature, <strong>union types are not special</strong>.</p>

<p>Union types are types. Like other types, we can store them in
variables. We can factor common error recovery code into helper
functions. We can map functions returning union types over lists. We
can write type aliases that abbreviate commonly-grouped error classes.
We can&rsquo;t do any of this with checked exceptions, and this is the most
common complaint against them.</p></li>
<li><p>Union types have <strong>call-site granularity</strong>, not method-body
granularity.</p>

<p>The union types approach forces a choice of how to handle errors at
each call site. This is more robust in the face of changing code,
because new call sites should not necessarily inherit the error
handling logic of existing call sites. Just because one
<code>ParseException</code> was uncaught and mentioned in the <code>throws</code> does not
mean all of them should be.</p></li>
</ul>


<p>And finally, let me get out ahead of some common counter arguments.</p>

<blockquote><p>The union types approach requires more typing at the call site!</p></blockquote>

<p>Yep. But I&rsquo;ve already counted this as a blessing, not a curse.</p>

<blockquote><p>But real-world Ruby code already uses exceptions!</p></blockquote>

<p>Yep. But in Java too, the world is already split into checked and
unchecked exceptions. In both Java and Ruby, exceptions are a fact of
life, and you&rsquo;ll always need a way to deal with unexpected exceptions
(e.g., comprehensive tests, automated production alerting, etc.).</p>

<blockquote><p>With checked exceptions, I could handle all the failures at once!</p></blockquote>

<p>That&rsquo;s true; with checked exceptions, it&rsquo;s easy to write a single
<code>catch</code> statement that handles all failures due to, say, a
<code>ParseException</code> in a whole region of code, avoiding the need for code
repetition.</p>

<p>The upshot is that with union types, we can just use functions. Take
everything in the <code>catch</code> body, put it in a helper function, and call it
at each call site.  This cuts down on duplication, and I already
mentioned how call-site granularity is a win.</p>

<h2>I love union types</h2>

<p>That&rsquo;s it, that&rsquo;s the whole take. Sorbet doesn&rsquo;t need checked exceptions, it
already has ad hoc union types.</p>

<hr />

<h2 id="appendix">Appendix: Checked Exceptions</h2>


<p>As a quick refresher, <a href="https://en.wikibooks.org/wiki/Java_Programming/Checked_Exceptions">checked exceptions</a> are a feature popularized by
Java.  The syntax looks like this:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">doThing</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">MyException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="o">}</span></span></code></pre></td></tr></table></div></figure>


<p>The <code>throws</code> keyword declares that in addition to the method&rsquo;s argument
types and return type, it might also throw <code>MyException</code>. If a method
throws multiple classes of exceptions, they can all be listed:</p>

<figure class='code'><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">doThing</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">MyException</span><span class="o">,</span> <span class="n">YourException</span><span class="o">,</span> <span class="n">AnotherException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="o">}</span></span></code></pre></td></tr></table></div></figure>


<p>The <code>throws</code> keyword is checked at all call sites, just like argument
and return types. A method containing calls to <code>doThing</code> must either
<code>catch</code> all mentioned exceptions or repeat the <code>throws</code> clause in its
own signature.</p>

<p>The argument in favor of checked exceptions is that it&rsquo;s explicit and
machine-checked. Users don&rsquo;t have to guess at what a method might throw,
or hope that there&rsquo;s accurate documentationâ€”all benefits shared by
static typing in general, which is a sympathetic goal.</p>

<p>Checked exceptions seem like a good feature on paper. In practice,
they&rsquo;re generally regretted. I&rsquo;m nowhere near the first person to come
to this conclusion, so instead I&rsquo;ll link you to some previous
discussions:</p>

<ul>
<li><a href="https://www.artima.com/articles/the-trouble-with-checked-exceptions">The Trouble with Checked Exceptions</a>, A Conversation
with Anders Hejlsberg</li>
<li><a href="http://james-iry.blogspot.com/2012/02/checked-exceptions-might-have-their.html">Checked Exceptions Might Have Their Place, But It Isn&rsquo;t In
Java</a>, by James Iry</li>
<li><a href="https://ericlippert.com/2008/09/10/vexing-exceptions/">Vexing Exceptions</a>, by Eric Lippert</li>
</ul>


<p>(The last one isn&rsquo;t actually about checked exceptions: it&rsquo;s just about
exceptions and I like it, so I included it.)</p>

<p>Java has been copied and imitated for decades. Among all the features we
see other languages copy from Java, checked exceptions are absent.</p>

    <footer class="entry-meta">
      <span class="entry-tags">
        <ul class="Tags">
          
            <li class="Tag">
              <a href="/categories/#ruby" title="Pages tagged ruby">ruby</a>
            </li>
          
            <li class="Tag">
              <a href="/categories/#sorbet" title="Pages tagged sorbet">sorbet</a>
            </li>
          
            <li class="Tag">
              <a href="/categories/#types" title="Pages tagged types">types</a>
            </li>
          
        </ul>
      </span>
      <span class="entry-date date published updated"><time datetime="2021-05-29T01:21:41-07:00">May 29, 2021</time></span>
      
    </footer>
  </div>
  
  <div class="read-more">
    
      <div class="read-more-header">
        <a href="/clangd-ruby/" class="Button">Read More</a>
      </div><!-- /.read-more-header -->
      <div class="read-more-content">
        <h3><a href="/clangd-ruby/" title="Exploring Ruby with clangd">Exploring Ruby with clangd</a></h3>
      <p>I&#8217;ve managed to get LSP-based IDE features powered by [clangd] working for the Ruby VM&#8217;s source code (in my case, in Vim). Here&#8217;s how I did it!
 <a href="/clangd-ruby/"> Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="/linkers-ruby-c-exts/" title="Linkers & Ruby C Extensions">Linkers & Ruby C Extensions</a></h4>
            <span>Published on June 7, 2020</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="/search-down-the-stack/" title="Search Down the Stack">Search Down the Stack</a></h4>
            <span>Published on June 6, 2020</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
  </div><!-- /.read-more -->


</div>

<div class="footer-wrapper">
  Blog source on <a href="https://github.com/jez/blog">GitHub</a>.

</div>

</body>
</html>
